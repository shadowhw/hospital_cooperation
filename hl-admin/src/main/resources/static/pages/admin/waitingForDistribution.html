<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员分配诊断</title>
    <link rel="stylesheet" href="/lib/layui/css/layui.css">
</head>

<style>
    .textarea {
        margin-right: 3px;
    }
    .button-style{
        background-color: #FFFFFF;border: #FFFFFF
    }
    .required {
        color: #ffb800;
        font-size: 32px;
        float: left;
        margin-left: 5px;
        margin-top: 5px;
        position: absolute;
        right: -15px;
    }
    .addinput {
        margin-right: 40px;
    }
</style>

<body>
<div class="layui-bg-gray" style="padding: 10px;">
    <div class="layui-row layui-col-space10">
        <div class="layui-col-md8">
            <div class="layui-card">
                <div class="layui-card-header">诊断信息</div>
                <div class="layui-card-body">
                    <sapn class="textarea">诊断编码：<span id="disgnose_code"></span></sapn>
                    <br>
                    <sapn class="textarea">申请单位：<span id="hos_nme"></span></sapn>
                    <br>
                    <sapn class="textarea">申请医生：<span id="doctor_name"></span></sapn>
                    <br>
                    <sapn class="textarea">诊&#12288;&#12288;断：</sapn><span id="diagnose_result"></span>
                    <br>
                    <sapn class="textarea">申请时间：<span id="create_time"></span></sapn>
                    <br>
                </div>
            </div>
            <div class="layui-card">
                <sapn class="textarea">患者姓名 : <span id="patient_name"></span></sapn>
                <br>
                <sapn class="textarea">患者出生日期 : <span id="patient_birth"></span></sapn>
                <br>
                <sapn class="textarea">患者身高 : <span id="patient_tall"></span>cm</sapn>
                <br>
                <sapn class="textarea">患者体重 : <span id="patient_weight"></span>kg</sapn>
                <br>
                <sapn class="textarea">STS评分 : <span id="patient_STS"></span></sapn>
                <br>
                <sapn class="textarea">左室舒张末期内径 : <span id="patient_LVDd"></span>mm</sapn>
                <br>
                <sapn class="textarea">左室收缩末期内径 : <span id="patient_LVDs"></span>mm</sapn>
                <br>
                <sapn class="textarea">左室射血分数 : <span id="patient_LVEF"></span>%</sapn>
                <br>
                <sapn class="textarea">瓣口直径 : <span id="patient_VD"></span>mm</sapn>
                <br>
                <sapn class="textarea">瓣口面积 : <span id="patient_VA"></span>mm²</sapn>
                <br>
                <sapn class="textarea">主动脉瓣峰值压力阶差 : <span id="patient_AVPPG"></span>mmHg</sapn>
                <br>
                <sapn class="textarea">主动脉瓣平均阶差 : <span id="patient_AVAPG"></span>mmHg</sapn>
                <br>
                <sapn class="textarea">主动脉瓣关闭不全 : <span id="patient_AVI"></span></sapn>
                <br>
                <sapn class="textarea">主动脉狭窄 : <span id="patient_AS"></span></sapn>
                <br>
                <sapn class="textarea">二尖瓣狭窄 : <span id="patient_MS"></span></sapn>
                <br>
                <sapn class="textarea">二尖瓣关闭不全 : <span id="patient_MI"></span></sapn>

            </div>
            <div class="layui-card">
                <div class="layui-card-header">诊断附件</div>
                <div class="layui-card-body">
                        <div>
                            <div class="layui-upload-list" style="max-width: 1000px;">
                                <table class="layui-table" id="demoList1">
                                </table>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="ok-body" style="background: #f8f8f8">
                <div class="layui-row">
                    <div style="background-color:#f8f8f8;">
                        <div style="background: #d2d2d2">
                            <div style="width: 100%;height: 100%;margin: 0 auto;">
                                <!--流程显示页面-->
                                <div style="background-color:#fdfdfd;">
                                    <iframe scrolling="yes" frameborder="0" width="100%"
                                            height="700px" id="processData"
                                            onload="this.height=0;var fdh=(this.Document?this.Document.body.scrollHeight:this.contentDocument.body.offsetHeight);this.height=(fdh>700?fdh:700)"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
        </div>
        <div class="layui-col-md4">
            <div style="background-color:#f8f8f8;padding-bottom: 300px">
                <legend class="layui-card-header" style="font-size: 16px">操作处理</legend>
                <div class="layui-card" style="background-color: #FFFFFF;padding-bottom: 50px">
                        <div class="layui-card-body">
                            <div class="layui-form">
                                <div class="layui-form-item" pane="">
                                    <div class="">
                                        <div class="layui-row a1" id="a1" style="margin-bottom: 15px">
                                            <div class="layui-col-md6">
                                                <button type="button" name="shenqing" id="backApply" class="layui-btn layui-btn-primary button-style">
                                                    <i class="layui-icon layui-icon-prev-circle" style="font-size: 18px;color: red;"></i>
                                                    <span>回退申请</span>
                                                </button>
                                            </div>
                                            <div class="layui-col-md6">
                                                <button type="button" name="shenqing" id="assignTasks" class="layui-btn layui-btn-primary button-style">
                                                    <i class="layui-icon layui-icon-auz" style="padding-top:10px;font-size: 18px;color: #1E9FFF;"></i>
                                                    <span>分配诊断任务</span>
                                                </button>
<!--                                                <input type="radio" name="shenqing" value="分配诊断任务" title="分配诊断任务">-->
                                            </div>
                                        </div>
                                        <div class="layui-row a2" id="a2">
                                            <div class="layui-col-md6">
                                                <button type="button" name="shenqing" id="rejectApply" class="layui-btn layui-btn-primary button-style">
                                                    <i class="layui-icon layui-icon-tips" style="padding-top:10px;font-size: 18px;color: gold;"></i>
                                                    <span>驳回诊断报告</span>
                                                </button>
                                            </div>
                                            <div class="layui-col-md6">
                                                <button type="button" name="shenqing" id="feedbackApply" class="layui-btn layui-btn-primary button-style">
                                                    <i class="layui-icon layui-icon-log" style="padding-top:10px;font-size: 20px;color: green;"></i>
                                                    <span>反馈诊断报告</span>
                                                </button>
<!--                                                <input type="radio" name="shenqing" value="反馈诊断报告" title="反馈诊断报告">-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="layui-form">
<!--                                <div id="choice_hos" class="layui-form-item" style="margin-top: 20px">-->
<!--                                    <div style="margin: 10px">医院</div>-->
<!--                                    <div class="layui-form-item layui-form-text" style="display: inline">-->
<!--                                        <select name="select_hos" lay-filter="select_hos" id="select_hos" lay-verify="required"></select>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div id="choice_doc" class="layui-form-item" style="margin-top: 20px">-->
<!--                                    <div style="margin: 10px">医生</div>-->
<!--                                    <div class="layui-form-item layui-form-text" style="display: inline">-->
<!--                                        <select name="select_doc" id="select_doc" lay-filter="select_doc" lay-verify="required"></select>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div class="layui-form-item" style="text-align: left">-->
<!--                                    <input type="radio" name="isread" value="1" title="已阅" checked="">-->
<!--                                    <input type="radio" name="isread1" value="2" title="已阅1" >-->
<!--                                </div>-->
<!--                                <div class="layui-form-item">-->
<!--                                    <textarea name="comment_text" id="comment_text" placeholder="请输入处理备注"-->
<!--                                              class="layui-textarea"></textarea>-->
<!--                                </div>-->
<!--                                <div class="layui-form-item" style="text-align: right">-->
<!--                                    <button type="button" class="layui-btn" lay-submit lay-filter="add" id="submit">确认</button>-->
<!--                                </div>-->
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
<!--回退申请弹框-->
<from style="display:none;margin: 20px 60px 20px 20px" class="layui-form" name="backApplybu" id="backApplybu" action=""
      lay-filter="useru">
    <div style="margin: 20px;">
        <div style="padding-left: 40px;">
            <span >提示：回退申请，需要填写回退原因。</span>
        </div>
        <div class="layui-form-item" style="margin-top: 20px;">
            <label class="layui-form-label">回退原因</label>
            <div class="layui-input-block" style="margin-right:40px">
                <textarea placeholder="请输入回退原因..." required lay-verify="required" class="layui-textarea" id="back_comm"></textarea>
            </div>
        </div>
    </div>
</from>
<!--分配诊断任务弹框-->
<from style="display:none;margin: 20px 60px 20px 20px" class="layui-form" name="assignTasksbu" id="assignTasksbu" action=""
      lay-filter="useru">
    <div style="margin: 20px">
        <div style="padding-left: 40px;">
            <span>提示：进行以下操作，分配此任务！</span>
        </div>
        <div id="choice_hos" class="layui-form-item" style="margin-top: 20px">
            <label class="layui-form-label">医&#12288;&#12288;院</label>
            <div class="layui-input-block addinput">
                <i class="required">*</i>
                <select name="select_hos" id="select_hos" lay-filter="select_hos" lay-verify="required">
                </select>
            </div>
        </div>
        <div id="choice_doc" class="layui-form-item" style="margin-top: 20px">
            <label class="layui-form-label">医&#12288;&#12288;生</label>
            <div class="layui-input-block addinput">
                <i class="required">*</i>
                <select name="select_doc" id="select_doc" lay-filter="select_doc" lay-verify="required"></select>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">操作备注</label>
            <div class="layui-input-block" style="margin-right:40px">
                <textarea placeholder="请输入备注..." lay-verify="required" class="layui-textarea" id="comm_task"></textarea>
            </div>
        </div>
    </div>
</from>
<!--驳回诊断报告弹框-->
<from style="display:none;margin: 20px 60px 20px 20px" class="layui-form" name="rejectApplybu" id="rejectApplybu" action=""
      lay-filter="useru">
    <div style="margin: 20px;">
        <div style="padding-left: 40px;">
            <span >提示：驳回诊断报告，需要填写原因。</span>
        </div>
        <div class="layui-form-item" style="margin-top: 20px;">
            <label class="layui-form-label">驳回原因</label>
            <div class="layui-input-block" style="margin-right:40px">
                <textarea placeholder="请输入原因..." lay-verify="required" class="layui-textarea" id="comm_bohui"></textarea>
            </div>
        </div>
    </div>
</from>
<!--反馈诊断报告弹框-->
<from style="display:none;margin: 20px 60px 20px 20px" class="layui-form" name="feedbackApplybu" id="feedbackApplybu" action=""
      lay-filter="useru">
    <div style="margin: 20px;">
        <div style="padding-left: 40px;">
            <span >提示：反馈诊断报告，需要填写反馈备注。</span>
        </div>
        <div class="layui-form-item" style="margin-top: 20px;">
            <label class="layui-form-label">反馈备注</label>
            <div class="layui-input-block" style="margin-right:40px">
                <textarea placeholder="请输入备注..." lay-verify="required" class="layui-textarea" id="comm_fankui"></textarea>
            </div>
        </div>
    </div>
</from>

</body>

<script src="../../lib/layui/layui.js"></script>
<script src="../../js/jquery.min.js"></script>
<script src="../../js/application.js"></script>
<script src="/js/hyx.js"></script>

<script>
    let d_id = GetQueryString("disgnose_id");

    let comment_text = $("#comment_text").val();
    let diagnosis_id =  GetQueryString("disgnose_id");

    //文件下载
    function downLoadFile(obj){
        var fileName = obj.name;
        console.log(fileName)
        window.open("/downLoadFileByFileName?fileName="+fileName)
    }

    //文件删除
    function deleteThiFile(obj){
        var fileName = obj.name;
        $.ajax({
            url: "/deleteThisFile?fileName="+fileName,
            type: "GET",
            success: function (obj){
                //删除回调
                if(obj.msg == "success"){ //删除成功
                    layer.msg("修改成功", {icon:1,time:1000},function(){
                        setTimeout('window.location.reload()',1000);
                    });
                }else{
                    layer.msg("失败")
                }
            }
        })
    }
    let admin_name = "";
    $.ajax({
        url: "/getInfo",
        type: "GET",
        success: function (obj){
            admin_name = obj.doctor_name;
        }
    })

    //流程信息
    let transact_comment = comment_text;
    //添加流程
    function add_process(transact_type2,fenfa) {
        //添加流程
        $.ajax({
            url: '/hos/process/add_process',
            dataType: 'json',
            type: 'post',
            data: {disgnose_id:d_id,fenfa:fenfa,transactor:admin_name,
                transact_type:transact_type2,
                transact_comment:transact_comment,
                transact_stat:1},
            success: function (resData) {
                if(resData.code == '201'){
                    layer.msg(resData.data.msg,{icon: 5});//失败的表情
                }else{
                    layer.msg("成功", {
                        icon: 6,//成功的表情
                        time: 1000 //1秒关闭（如果不配置，默认是3秒）
                    }, function(){
                        window.location.reload();
                    });
                }
            }
        });
    };

    layui.use(['form','laydate',"table","layer"], function () {
        // layui引入需要的组件
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        //获取诊断编号
        var disgnose_id = GetQueryString("disgnose_id");
        //附件信息渲染
        table.render({
            elem: '#demoList1'
            , url: '/getAttchedAndResutAttched?disgnose_id='+disgnose_id
            , title: '文件'
            , page: false
            , parseData: function (res) {
                let datas = res.data;
                let rs = [];
                for (let i = 0; i < datas.length; i++) {
                    let dia = {}
                    dia.fileName = datas[i].attached.attched_name;
                    dia.fileName2 = dia.fileName.substr(33)
                    dia.type = datas[i].type;
                    let fName = dia.fileName;
                    dia.download = '<button type="button" class="layui-btn layui-btn-sm" name="'+fName+'" onclick="downLoadFile(this)">下载</button>' + '<button type="button" class="layui-btn layui-btn-sm" name="'+fName+'" onclick="deleteThiFile(this)">删除</button>'
                    rs.push(dia)
                }
                return {
                    "code": 0, //解析接口状态
                    "msg": res.msg,
                    "count": res.count,
                    "data": rs //解析数据列表
                };
            },
            cols: [[
                //序列号
                {field: 'fileName',title: "文件名称",hide: true},
                {field: 'fileName2', title: "文件名称"}
                , {field: 'type',  title: '类型', width: 100}
                ,{field: 'download' ,title: '操作',width:175 }
            ]
            ]
        });

        // 二级联动 第一步 渲染父级
        $.ajax({
            url: '/hos/hos_info/get_hos_list_no_page',	// 后台取到所有的科室名称
            dataType: 'json',
            type: 'get',
            success: function (resData) {

                $.each(resData.data, function (index, value) {
                    // 这里的 value.roomName
                    // 前者是页面显示的值，后者是传递给后台的值。
                    // 正常情况下，后者应该是 value.id
                    $('#select_hos').append(new Option(value.hos_name, value.id));	// 下拉菜单里添加元素
                });

                //渲染select
                form.render('select');
                //预加载
                $.ajax({
                    url: '/hos/doctor_info/get_doc_of_hos',
                    dataType: 'json',
                    type: 'get',
                    data: {hos_id:1,type:"xz"},
                    success: function (resData) {
                        // 清空选项
                        $('#select_doc').empty();
                        $.each(resData.data, function (index, value) {
                            // 这里的 value.bedNo
                            // 前者是页面显示的值，后者是传递给后台的值。
                            // 正常情况下，后者应该是 value.id
                            $('#select_doc').append(new Option(value.doctor_name, value.doctor_account));// 下拉菜单里添加元素
                        });
                        //渲染select
                        form.render('select');
                    }
                });
            }
        });
        // 第二步 监听父级，每当父级发生变化时，渲染子级的值
        form.on('select(select_hos)', function(data){
            var hos_id = data.value; // roomName 选中的科室名称
            $.ajax({
                url: '/hos/doctor_info/get_doc_of_hos',
                dataType: 'json',
                type: 'get',
                data: {hos_id:hos_id,type:"xz"},
                success: function (resData) {
                    // 清空选项
                    $('#select_doc').empty();
                    $.each(resData.data, function (index, value) {
                        // 这里的 value.bedNo
                        // 前者是页面显示的值，后者是传递给后台的值。
                        // 正常情况下，后者应该是 value.id
                        $('#select_doc').append(new Option(value.doctor_name, value.doctor_account));// 下拉菜单里添加元素
                    });
                    //渲染select
                    form.render('select');
                }
            });

        });

        //更新诊断表
        function update_diagnosis(stat2,comm) {
            $.ajax({
                url: '/hos/diagnosis_info/update_diagnosis_info',
                dataType: 'json',
                type: 'post',
                data: {id:diagnosis_id,comment_text:comm,stat:stat2},
                success: function (resData) {
                    if(resData.code == '201'){
                        layer.msg(resData.data.msg,{icon: 5});//失败的表情
                    }else{
                        layer.msg("成功", {
                            icon: 6,//成功的表情
                            time: 1000 //1秒关闭（如果不配置，默认是3秒）
                        }, function(){
                            window.location.reload();
                        });
                    }
                }
            });
        };

        $("#backApply").on("click", function(){
            console.log($("#back_comm").val())
            var index = layer.open({
                type: 1,
                title: ['回退申请', 'font-size:14px; color:red;'],//数组第二项可以写任意css样式；如果你不想显示标题栏，你可以title: false
                shade: 0.6,
                maxmin: true,//允许全屏最小化
                id: (new Date()).valueOf(), //设定一个id，防止重复弹出 时间戳1280977330748
                btn: ['保存', '取消'],
                btnAlign: 'r',
                area: ['480px', '350px'],
                content: $("#backApplybu"),
                btn: ['确定', '取消'],
                yes: function(index, layero){
                    //do something
                    // alert("确定回退吗？");
                    if($("#back_comm").val()=="")
                    {
                        alert("备注不能为空");
                        return;
                    }

                    update_diagnosis(2,$("#back_comm").val());
                    add_process("回退诊断申请",$("#doctor_name").text());
                    layer.close(index); //如果设定了yes回调，需进行手工关闭
                },
                btn2: function(index, layero){
                    alert("确定取消回退吗？");
                    layer.close(index)
                }
            });
        })

    });
    //分配
    $("#assignTasks").on("click", function(){
        var index = layer.open({
            type: 1,
            title: ['分配诊断任务', 'font-size:14px; color:#1E9FFF;'],
            shade: 0.6,
            maxmin: true,//允许全屏最小化
            id: (new Date()).valueOf(),
            btn: ['保存', '取消'],
            btnAlign: 'r',
            area: ['520px', '420px'],
            content: $("#assignTasksbu"),
            btn: ['确定', '取消'],
            yes: function(index, layero){
                //do something
                //alert("确定此操作吗？");
                $.ajax({
                    url: '/hos/diagnosis_info/update_diagnosis_info',
                    dataType: 'json',
                    type: 'post',
                    data: {id:d_id,comment_text:$("#comm_task").val(),stat:3},
                    success: function (resData) {
                        if(resData.code == '201'){
                            layer.msg(resData.data.msg,{icon: 5});//失败的表情
                        }else{
                            //添加分配信息
                            $.ajax({
                                url: '/hos/doctor_with_disgnose/add_assist',
                                dataType: 'json',
                                type: 'post',
                                data: {disgnose_id:d_id,doctor_account:$("#select_doc").find("option:selected").val()},
                                success: function (resData2) {
                                    if(resData2.code == '201'){
                                        layer.msg(resData2.data.msg,{icon: 5});//失败的表情
                                    }else{

                                        layer.msg("成功", {
                                            icon: 6,//成功的表情
                                            time: 1000 //1秒关闭（如果不配置，默认是3秒）
                                        }, function(){
                                            window.location.reload();
                                        });
                                    }
                                }
                            });
                        }
                    }
                });
                add_process("管理已分配诊断任务",$("#doctor_name").text());
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            },
            btn2: function(index, layero){
                alert("确定取消此操作吗？");
                layer.close(index)
            }
        });
    })
    //驳回
    $("#rejectApply").on("click", function(){
        var index = layer.open({
            type: 1,
            title: ['驳回诊断报告', 'font-size:14px; color:gold;'],
            shade: 0.6,
            maxmin: true,//允许全屏最小化
            id: (new Date()).valueOf(),
            btn: ['保存', '取消'],
            btnAlign: 'r',
            area: ['480px', '350px'],
            content: $("#rejectApplybu"),
            btn: ['确定', '取消'],
            yes: function(index, layero){
                //修改无法驳回问题，出现原因在这,2021.10.18
                // if($("#comm_task").val()=="")
                // {
                //     alert("备注不能为空");
                //     return;
                // }
                //do something
                //alert("确定回退吗？");
                if($("#comm_bohui").val()=="")
                {
                    alert("备注不能为空");
                    return;
                }
                $.ajax({
                    url: '/hos/diagnosis_info/update_diagnosis_info',
                    dataType: 'json',
                    type: 'post',
                    data: {id:d_id,comment_text:$("#comm_bohui").val(),stat:4},
                    success: function (resData) {
                        if(resData.code == '201'){
                            layer.msg(resData.data.msg,{icon: 5});//失败的表情
                        }else{
                            layer.msg("成功", {
                                icon: 6,//成功的表情
                                time: 1000 //1秒关闭（如果不配置，默认是3秒）
                            }, function(){
                                window.location.reload();
                            });
                        }
                    }
                });
                add_process("管理已驳回诊断报告",$("#doctor_name").text());
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            },
            btn2: function(index, layero){
                alert("确定取消驳回吗？");
                layer.close(index)
            }
        });
    })
    //反馈
    $("#feedbackApply").on("click", function(){
        var index = layer.open({
            type: 1,
            title: ['反馈诊断报告', 'font-size:14px; color:green;'],
            shade: 0.6,
            maxmin: true,//允许全屏最小化
            id: (new Date()).valueOf(),
            btn: ['保存', '取消'],
            btnAlign: 'r',
            area: ['480px', '350px'],
            content: $("#feedbackApplybu"),
            btn: ['确定', '取消'],
            yes: function(index, layero){
                //do something
                $.ajax({
                    url: '/hos/diagnosis_info/update_diagnosis_info',
                    dataType: 'json',
                    type: 'post',
                    data: {id:d_id,comment_text:$("#comm_fankui").val(),stat:5},
                    success: function (resData) {
                        if(resData.code == '201'){
                            layer.msg(resData.data.msg,{icon: 5});//失败的表情
                        }else{
                            layer.msg("成功", {
                                icon: 6,//成功的表情
                                time: 1000 //1秒关闭（如果不配置，默认是3秒）
                            }, function(){
                                window.location.reload();
                            });
                        }
                    }
                });
                add_process("诊断任务已完成",$("#doctor_name").text());
                layer.close(index);
            },
            btn2: function(index, layero){
                alert("确定取消操作吗？");
                layer.close(index)
            }
        });
    })
</script>

<script>
    $(document).ready(function(){
        //获取诊断编号
        var disgnose_id = GetQueryString("disgnose_id");

        //甚至诊断iframe的src
        $("#processData").attr("src","/pages/commonData/processData.html?disgnose_id="+disgnose_id);

        //设置分配信息
        $.ajax({
            url:'/hos/diagnosis_info/get_diagnosis_by_id',
            type:'get',
            data:{
                'id':disgnose_id
            },
            success:function(data){
                if(data.code == '201'){
                    alert(data.data.msg);//失败的表情
                }else{
                    let datas = data.data;
                    let rs = [];
                    for(let i=0;i<datas.length;i++)
                    {
                        let dia = {};
                        //格式化时间
                        let date = new Date(datas[i].disgnose_info.create_time).Format("yyyy-MM-dd HH:mm:ss");
                        //出生日期
                        let birth = new Date(datas[i].disgnose_info.patient_birth).Format("yyyy-MM-dd");

                        dia.doctor_name = datas[i].doctor_info.doctor_name;
                        dia.patient_name = datas[i].disgnose_info.patient_name;
                        dia.patient_birth = birth;
                        dia.patient_tall = datas[i].disgnose_info.patient_tall;
                        dia.patient_weight = datas[i].disgnose_info.patient_weight;
                        dia.diagnose_result = datas[i].disgnose_info.diagnose_result;
                        dia.hos_nme = datas[i].hos_info.hos_name;
                        dia.create_time = date;
                        dia.comment_text = datas[i].disgnose_info.comment_text;
                        dia.disgnose_code = datas[i].disgnose_info.disgnose_code;
                        dia.stat = datas[i].disgnose_info.stat;

                        dia.patient_BMI = datas[i].disgnose_info.patient_BMI;
                        dia.comment_text = datas[i].disgnose_info.comment_text;
                        dia.disgnose_code = datas[i].disgnose_info.disgnose_code;
                        dia.patient_STS = datas[i].disgnose_info.patient_STS
                        dia.patient_LVDd = datas[i].disgnose_info.patient_LVDd
                        dia.patient_LVDs = datas[i].disgnose_info.patient_LVDs
                        dia.patient_LVEF = datas[i].disgnose_info.patient_LVEF
                        dia.patient_VD = datas[i].disgnose_info.patient_VD
                        dia.patient_VA = datas[i].disgnose_info.patient_VA
                        dia.patient_AVPPG = datas[i].disgnose_info.patient_AVPPG
                        dia.patient_AVAPG = datas[i].disgnose_info.patient_AVAPG

                        dia.patient_AS = datas[i].disgnose_info.patient_AS
                        if (dia.patient_AS == 1) dia.patient_AS == "轻度";
                        else if (dia.patient_AS == 2) dia.patient_AS == "中度"
                        else if (dia.patient_AS == 3) dia.patient_AS = "重度"

                        dia.patient_AVI = datas[i].disgnose_info.patient_AVI
                        if (dia.patient_AVI == 1) dia.patient_AVI = "轻度";
                        else if (dia.patient_AVI == 2) dia.patient_AVI = "中度"
                        else if (dia.patient_AVI == 3) dia.patient_AVI = "重度"

                        dia.patient_MS = datas[i].disgnose_info.patient_MS
                        if (dia.patient_MS == 1) dia.patient_MS = "轻度";
                        else if (dia.patient_MS == 2) dia.patient_MS = "中度"
                        else if (dia.patient_MS == 3) dia.patient_MS = "重度"

                        dia.patient_MI = datas[i].disgnose_info.patient_MI
                        if (dia.patient_MI == 1) dia.patient_MI = "轻度";
                        else if (dia.patient_MI == 2) dia.patient_MI = "中度"
                        else if (dia.patient_MI == 3) dia.patient_MI = "重度"


                        //添加状态缓存
                        switch (dia.stat) {
                            case 1:
                                localStorage.setItem("cur_stat","录入医师创建申请");
                                break;
                            case 2:
                                localStorage.setItem("cur_stat","管理员已退回诊断申请");
                                break;
                            case 3:
                                localStorage.setItem("cur_stat","管理员已分配等待协作专家处理");
                                break;
                            case 4:
                                localStorage.setItem("cur_stat","管理员已驳回协助医师报告");
                                break;
                            case 5:
                                localStorage.setItem("cur_stat","诊断任务已完成");
                                break;
                            case 6:
                                localStorage.setItem("cur_stat","协作专家完成诊断等待管理员处理");
                                break;
                        }

                        $("#hos_nme").text(dia.hos_nme)
                        $("#patient_name").text(dia.patient_name)
                        $("#patient_birth").text(dia.patient_birth)
                        $("#patient_tall").text(dia.patient_tall)
                        $("#patient_weight").text(dia.patient_weight)
                        $("#diagnose_result").text(dia.diagnose_result)
                        $("#doctor_name").text(dia.doctor_name)
                        $("#create_time").text(dia.create_time)
                        $("#disgnose_code").text(dia.disgnose_code)
                        $("#patient_bmi").text(dia.patient_BMI)
                        //new Clome 2021:11.5
                        $("#patient_STS").text(dia.patient_STS)
                        $("#patient_LVDd").text(dia.patient_LVDd)
                        $("#patient_LVDs").text(dia.patient_LVDs)
                        $("#patient_LVEF").text(dia.patient_LVEF)
                        $("#patient_VD").text(dia.patient_VD)
                        $("#patient_VA").text(dia.patient_VA)
                        $("#patient_AVPPG").text(dia.patient_AVPPG)
                        $("#patient_AVAPG").text(dia.patient_AVAPG)

                        $("#patient_AS").text(dia.patient_AS)
                        $("#patient_AVI").text(dia.patient_AVI)
                        $("#patient_MS").text(dia.patient_MS)
                        $("#patient_MI").text(dia.patient_MI)
                        //根据诊断状态显示不同的操作菜单
                        switch (dia.stat) {
                            case 1://创建状态不能驳回和反馈
                                // $("#choice_hos").hide();
                                $("#a1").show();
                                $("#assignTasks").show();
                                $("#a2").hide();
                                // $("input:radio").eq(0).attr("disabled",false);
                                // $("input:radio").eq(1).attr("disabled",false);
                                // $("input:radio").eq(2).attr("disabled",true);
                                // $("input:radio").eq(3).attr("disabled",true);
                                break;
                            case 2://退回后不能分配,也不显示回退
                                $("#assignTasks").hide();
                                $("#a2").hide();
                                $("#a1").hide();
                                // $("input:radio").eq(0).attr("disabled",false);
                                // $("input:radio").eq(1).attr("disabled",true);
                                // $("input:radio").eq(2).attr("disabled",true);
                                // $("input:radio").eq(3).attr("disabled",true);
                                break;
                            case 3://已分配后啥也不显示
                                $("#assignTasks").hide();
                                $("#a2").hide();
                                $("#a1").hide();
                                break;
                            case 4:
                                $("#a1").hide();
                                $("#a2").hide();
                                break;
                            //诊断医师完成后显示驳回和反馈
                            case 6:
                                $("#a1").hide();
                                $("#a2").show();
                                // $("#choice_hos").hide();
                                // $("#choice_doc").hide();
                                // $("input:radio").eq(0).attr("disabled",true);
                                // $("input:radio").eq(1).attr("disabled",true);
                                // $("input:radio").eq(2).attr("disabled",false);
                                // $("input:radio").eq(3).attr("disabled",false);
                                break;
                            case 5://完成什么都不显示
                                $("#a1").hide();
                                $("#a2").hide();
                                break;
                        }
                    }
                }
            },
        });

    });
</script>

<script>
    let processDataHeight = 0;
    //获取处理过程信息
    function getprocessData(processId) {
        $("#processData").on("load", function () {
            var data = {processId: processId}
            this.contentWindow.getParentData(data)
        })
    }

    layui.use(['element','form'], function () {
        var form = layui.form;
        form.render('select');
    });


    // function caseReturnData(returnData) {
    //
    // }

    function processReturnData(returnData) {
        $("#processData").height(returnData.height)
        processDataHeight = returnData.height
    }
</script>
<script>
    //文件下载
    function downLoadFile(obj){
        var fileName = obj.name;
        window.open("/downLoadFileByFileName?fileName="+fileName)
    }

    //文件删除
    function deleteThiFile(obj){
        var fileName = obj.name;
        $.ajax({
            url: "/deleteThisFile?fileName="+fileName,
            type: "GET",
            success: function (obj){
                //删除回调
                if(obj.msg == "success"){ //删除成功
                    layer.msg("修改成功", {icon:1,time:1000},function(){
                        setTimeout('window.location.reload()',1000);
                    });
                }else{
                    layer.msg("失败")
                }
            }
        })
    }

    //获取诊断编号
    var disgnose_id = GetQueryString("disgnose_id");
    // $.ajax({
    //     url: '/getAttchedAndResutAttched',
    //     data: {
    //         disgnose_id:disgnose_id,
    //     },
    //     success: function(obj){
    //         console.log(obj)
    //     }
    // })
    layui.use(["layer", "table"], function () {
        var layer = layui.layer;
        var table = layui.table;
        table.render({
            elem: '#demoList1'
            , url: '/getAttchedAndResutAttched?disgnose_id=' + disgnose_id
            , title: '文件'
            , page: false
            , parseData: function (res) {
                let datas = res.data;
                // console.log(datas.length)
                let rs = [];
                for (let i = 0; i < datas.length; i++) {
                    let dia = {}
                    dia.fileName = datas[i].attached.attched_name;
                    dia.type = datas[i].type;
                    dia.download = '<button type="button" class="layui-btn layui-btn-sm" name="'+dia.fileName+'" onclick="downLoadFile(this)">下载</button>' + '<button type="button" class="layui-btn layui-btn-sm" name="'+dia.fileName+'" onclick="deleteThiFile(this)">删除</button>'

                    rs.push(dia)
                }
                return {
                    "code": 0, //解析接口状态
                    "msg": res.msg,
                    "count": res.count,
                    "data": rs //解析数据列表
                };
            },
            cols: [[
                //序列号
                {field: 'fileName', title: "文件名称"}
                , {field: 'type', title: '类型', width: 100}
                ,{field: 'download' ,title: '操作',width:175 }
            ]
            ]
        });
    });
</script>
</html>